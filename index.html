<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>穿山甲追蹤地圖 250424PA01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .legend {
      background: white;
      line-height: 1.5;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .legend img {
      vertical-align: middle;
      height: 20px;
      width: 20px;
    }
    .info-control {
      background: white;
      line-height: 1.7;
      padding: 12px 14px;
      font-size: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      margin: 10px;
      min-width: 260px;
      max-width: 400px;
      word-break: break-all;
    }
    .leaflet-control.compass-custom {
      background: white;
      padding: 4px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    .leaflet-control.compass-custom img {
      width: 40px;
      height: 40px;
      display: block;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>
  <script>
    const map = L.map('map').setView([22.91, 121.09], 15);

    // 底圖
    const normalMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    });
    const contourMap = L.tileLayer('https://tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data: &copy; OpenTopoMap (CC-BY-SA)',
      maxZoom: 17
    });
    const baseMaps = {
      "一般地圖": normalMap,
      "等高線地圖": contourMap
    };

    // GPX 路線圖層
    const carLayer = new L.GPX('car.gpx', {
      async: true,
      polyline_options: { color: 'red', weight: 4 },
      marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
      }
    });
    const scooterLayer = new L.GPX('scooter.gpx', {
      async: true,
      polyline_options: { color: 'yellow', weight: 4, dashArray: '4,4' },
      marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
      }
    });
    const hikingLayer = new L.GPX('hiking.gpx', {
      async: true,
      polyline_options: { color: 'green', weight: 3, dashArray: '1,6' },
      marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
      }
    });

    const overlayMaps = {
      "車輛通行路線": carLayer,
      "摩托車路線": scooterLayer,
      "徒步路線": hikingLayer
    };

    L.control.layers(baseMaps, overlayMaps, { collapsed: false, position: 'topright' }).addTo(map);

    // 自訂 compass 圖示（右上角）
    const CompassControl = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-control compass-custom');
        const img = L.DomUtil.create('img', '', container);
        img.src = 'compass.png';
        img.alt = '指北針';
        return container;
      }
    });
    map.addControl(new CompassControl());

    // 預設底圖和所有 GPX 路線都加到地圖
    normalMap.addTo(map);
    carLayer.addTo(map);
    scooterLayer.addTo(map);
    hikingLayer.addTo(map);

    // 比例尺
    L.control.scale().addTo(map);

    // 顯示使用者位置
    map.locate({ setView: true, maxZoom: 16 });
    map.on('locationfound', function(e) {
      L.circleMarker(e.latlng, {
        radius: 6, color: 'blue', fillColor: '#30f', fillOpacity: 0.6
      }).addTo(map).bindPopup("你目前的位置").openPopup();
    });

    // 自訂圖示
    const animalIcon = L.icon({
      iconUrl: 'animal-icon.png',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });
    const eyeIcon = L.icon({
      iconUrl: 'eye-icon.png',
      iconSize: [25, 25],
      iconAnchor: [12, 12],
      popupAnchor: [0, -12]
    });
    const signalIcon = L.icon({
      iconUrl: 'signal-icon.png',
      iconSize: [25, 25],
      iconAnchor: [12, 12],
      popupAnchor: [0, -12]
    });

    // 資訊欄（不含「時間」字樣）
    const infoControl = L.control({ position: 'topleft' });
    infoControl.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'info-control');
      div.innerHTML = `
        <b>最新定位</b>：<span id="latest-time">載入中...</span><br>
        <b>最後成功定位</b>：<span id="last-success-time">載入中...</span>
      `;
      return div;
    };
    infoControl.addTo(map);

    // 三個表的 CSV 下載網址
    const mainSheetUrl = 'https://docs.google.com/spreadsheets/d/1yIXjdfUI8TeV5ifB6oUSeFbfc0Hj2RmMiF1Q50W84pQ/export?format=csv&gid=0';
    const monitorSheetUrl = 'https://docs.google.com/spreadsheets/d/1yIXjdfUI8TeV5ifB6oUSeFbfc0Hj2RmMiF1Q50W84pQ/export?format=csv&gid=1274944193';
    const markerSheetUrl = 'https://docs.google.com/spreadsheets/d/1yIXjdfUI8TeV5ifB6oUSeFbfc0Hj2RmMiF1Q50W84pQ/export?format=csv&gid=730047739';

    // 分別存資料
    let mainData = null, monitorData = null, markerData = null;

    function tryRender() {
      if (!mainData || !monitorData || !markerData) return;

      // --------- 主資料：track 路徑 ---------
      const trackWithCoord = mainData.filter(d => d.lat && d.lng && d.timestamp);
      // 最新定位
      let latestTrack = trackWithCoord.reduce((max, curr) =>
        (!max || new Date(curr.timestamp) > new Date(max.timestamp)) ? curr : max, null);
      let latestTime = latestTrack ? latestTrack.timestamp : '無資料';
      // 最後定位成功
      let lastSuccessTrack = trackWithCoord.reduce((max, curr) =>
        (!max || new Date(curr.timestamp) > new Date(max.timestamp)) ? curr : max, null);
      let lastSuccessTime = lastSuccessTrack ? lastSuccessTrack.timestamp : '無資料';

      document.getElementById('latest-time').textContent = latestTime;
      document.getElementById('last-success-time').textContent = lastSuccessTime;

      // 畫出 track 路徑
      const trackPoints = trackWithCoord.map(d => ({
        lat: parseFloat(d.lat),
        lng: parseFloat(d.lng),
        timestamp: d.timestamp,
        note: d.note
      }));
      const latlngs = trackPoints.map(p => [p.lat, p.lng]);
      if (latlngs.length) {
        const polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
        map.fitBounds(polyline.getBounds());
        trackPoints.slice(0, -1).forEach(p => {
          if (p.note && p.note.includes('發現點')) {
            L.marker([p.lat, p.lng], { icon: eyeIcon })
              .addTo(map)
              .bindPopup(`<b>${p.note}</b><br>${p.timestamp}`);
          } else {
            L.circleMarker([p.lat, p.lng], {
              radius: 6, color: 'gray', fillColor: 'gray', fillOpacity: 0.6
            }).addTo(map).bindPopup(`<b>${p.note || '無備註'}</b><br>${p.timestamp}`);
          }
        });
        const latestPos = trackPoints[trackPoints.length - 1];
        L.marker([latestPos.lat, latestPos.lng], { icon: animalIcon })
          .addTo(map)
          .bindPopup(`<b>最新位置</b><br>${latestPos.timestamp}<br>${latestPos.note || ''}`);
      }

      // --------- marker sheet 的點位 ---------
      markerData
        .filter(d => d.lat && d.lng)
        .forEach(p => {
          L.marker([parseFloat(p.lat), parseFloat(p.lng)])
            .addTo(map)
            .bindPopup(`<b>${p.note || '標記點'}</b>`);
        });

      // --------- 監聽點 sheet 的點位 ---------
      monitorData
        .filter(d => d.lat && d.lng)
        .forEach(p => {
          L.marker([parseFloat(p.lat), parseFloat(p.lng)], { icon: signalIcon })
            .addTo(map)
            .bindPopup(`<b>${p.note || '監聽點'}</b>`);
        });
    }

    // 載入主資料（sheet1）
    Papa.parse(mainSheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        mainData = results.data;
        tryRender();
      }
    });
    // 載入監聽點資料
    Papa.parse(monitorSheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        monitorData = results.data;
        tryRender();
      }
    });
    // 載入 marker 資料
    Papa.parse(markerSheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        markerData = results.data;
        tryRender();
      }
    });

    // 圖例
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <b>圖例</b><br>
        <img src="animal-icon.png"> 最新位置<br>
        <span style="color: blue;">●</span> 移動路徑<br>
        <img src="eye-icon.png"> 發現點<br>
        <img src="signal-icon.png"> 監聽點<br>
        <span style="color: red;">━━</span> 車輛通行路線<br>
        <span style="color: yellow;">- - -</span> 摩托車路線<br>
        <span style="color: green;">⋯⋯⋯</span> 徒步路線
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
