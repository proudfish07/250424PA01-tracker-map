<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>穿山甲追蹤地圖 250424PA01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-compass/dist/leaflet-compass.css" />
  <style>
    #map { height: 100vh; }
    .legend {
      background: white;
      line-height: 1.5;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .legend img {
      vertical-align: middle;
      height: 20px;
      width: 20px;
    }
    .info-control {
      background: white;
      line-height: 1.7;
      padding: 12px 14px;
      font-size: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      margin: 10px;
      min-width: 180px;
      max-width: 270px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-compass/dist/leaflet-compass.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>

  <script>
    const map = L.map('map').setView([22.91, 121.09], 15);

    // 定義底圖
    const normalMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    });
    const contourMap = L.tileLayer('https://tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data: &copy; OpenTopoMap (CC-BY-SA)',
      maxZoom: 17
    });

    const baseMaps = {
      "一般地圖": normalMap,
      "等高線地圖": contourMap
    };

    // GPX 路線圖層
    const carLayer = new L.GPX('car.gpx', {
      async: true,
      polyline_options: { color: 'red', weight: 4 },
      marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
      }
    });
    const scooterLayer = new L.GPX('scooter.gpx', {
      async: true,
      polyline_options: { color: 'orange', weight: 4, dashArray: '4,4' },
      marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
      }
    });
    const hikingLayer = new L.GPX('hiking.gpx', {
      async: true,
      polyline_options: { color: 'green', weight: 3, dashArray: '1,6' },
      marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
      }
    });

    // overlayMaps 只包含 GPX，不會因底圖切換而關閉
    const overlayMaps = {
      "車輛通行路線": carLayer,
      "摩托車路線": scooterLayer,
      "徒步路線": hikingLayer
    };

    // 先加地圖切換控制（等高線/一般地圖）
    L.control.layers(baseMaps, overlayMaps, { collapsed: false, position: 'topright' }).addTo(map);

    // 再加指北針控制
    const compass = new L.Control.Compass({ position: 'topright', autoActive: true, showDigit:true });
    compass.addTo(map);

    // 預設底圖和所有 GPX 路線都加到地圖
    normalMap.addTo(map);
    carLayer.addTo(map);
    scooterLayer.addTo(map);
    hikingLayer.addTo(map);

    // 比例尺
    L.control.scale().addTo(map);

    // 顯示使用者位置
    map.locate({ setView: true, maxZoom: 16 });
    map.on('locationfound', function(e) {
      L.circleMarker(e.latlng, {
        radius: 6, color: 'blue', fillColor: '#30f', fillOpacity: 0.6
      }).addTo(map).bindPopup("你目前的位置").openPopup();
    });

    // 自訂圖示
    const animalIcon = L.icon({
      iconUrl: 'animal-icon.png',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });
    const eyeIcon = L.icon({
      iconUrl: 'eye-icon.png',
      iconSize: [25, 25],
      iconAnchor: [12, 12],
      popupAnchor: [0, -12]
    });
    const signalIcon = L.icon({
      iconUrl: 'signal-icon.png',
      iconSize: [25, 25],
      iconAnchor: [12, 12],
      popupAnchor: [0, -12]
    });

    // 資訊欄
    const infoControl = L.control({ position: 'topleft' });
    infoControl.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'info-control');
      div.innerHTML = `
        <b>最新定位</b><br>
        <span id="latest-info">資料載入中...</span>
      `;
      return div;
    };
    infoControl.addTo(map);

    // 讀取 CSV
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMQAVWyU35axF8U2xIOjIsvD7FpCFjsbdlOGZYhZG5XF7qGgIsOoVc0EaFSpcda6jiObHTvUtbXF9U/pub?output=csv';

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        let data = results.data.filter(d => d.lat && d.lng);
        const trackPoints = data
          .filter(d => d.type === 'track')
          .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
          .map(d => ({
            lat: parseFloat(d.lat),
            lng: parseFloat(d.lng),
            timestamp: d.timestamp,
            note: d.note
          }));
        const markerPoints = data
          .filter(d => d.type === 'marker')
          .map(d => ({
            lat: parseFloat(d.lat),
            lng: parseFloat(d.lng),
            note: d.note
          }));
        const latlngs = trackPoints.map(p => [p.lat, p.lng]);
        if (latlngs.length) {
          const polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
          map.fitBounds(polyline.getBounds());
          trackPoints.slice(0, -1).forEach(p => {
            if (p.note && p.note.includes('發現點')) {
              L.marker([p.lat, p.lng], { icon: eyeIcon })
                .addTo(map)
                .bindPopup(`<b>${p.note}</b><br>${p.timestamp}`);
            } else {
              L.circleMarker([p.lat, p.lng], {
                radius: 6, color: 'gray', fillColor: 'gray', fillOpacity: 0.6
              }).addTo(map).bindPopup(`<b>${p.note || '無備註'}</b><br>${p.timestamp}`);
            }
          });
          const latest = trackPoints[trackPoints.length - 1];
          L.marker([latest.lat, latest.lng], { icon: animalIcon })
            .addTo(map)
            .bindPopup(`<b>最新位置</b><br>${latest.timestamp}<br>${latest.note || ''}`);
          // 資訊欄只顯示最後定位時間和經緯度
          document.getElementById('latest-info').innerHTML =
            `座標：${latest.lat.toFixed(5)}, ${latest.lng.toFixed(5)}<br>時間：${latest.timestamp}`;
        } else {
          document.getElementById('latest-info').innerHTML = '無追蹤資料';
        }
        markerPoints.forEach(p => {
          if (p.note && p.note.includes('監聽點')) {
            L.marker([p.lat, p.lng], { icon: signalIcon })
              .addTo(map)
              .bindPopup(`<b>${p.note}</b>`);
          } else {
            L.marker([p.lat, p.lng])
              .addTo(map)
              .bindPopup(`<b>${p.note || '標記點'}</b>`);
          }
        });
      }
    });

    // 圖例
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <b>圖例</b><br>
        <img src="animal-icon.png"> 最新位置<br>
        <span style="color: blue;">●</span> 移動路徑<br>
        <img src="eye-icon.png"> 發現點<br>
        <img src="signal-icon.png"> 監聽點<br>
        <span style="color: red;">━━</span> 車輛通行路線<br>
        <span style="color: yellow;">- - -</span> 摩托車路線<br>
        <span style="color: green;">⋯⋯⋯</span> 徒步路線
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
