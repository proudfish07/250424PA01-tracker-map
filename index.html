<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>穿山甲追蹤地圖 250424PA01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const map = L.map('map').setView([22.91, 121.09], 15);

    // 使用 OpenStreetMap 底圖
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    // 加入比例尺
    L.control.scale().addTo(map);

    // 自訂圖示
    const animalIcon = L.icon({
      iconUrl: 'animal-icon.png',
      iconSize: [80, 80],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMQAVWyU35axF8U2xIOjIsvD7FpCFjsbdlOGZYhZG5XF7qGgIsOoVc0EaFSpcda6jiObHTvUtbXF9U/pub?output=csv';

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        let data = results.data.filter(d => d.lat && d.lng);

        const trackPoints = data
          .filter(d => d.type === 'track')
          .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
          .map(d => ({
            lat: parseFloat(d.lat),
            lng: parseFloat(d.lng),
            timestamp: d.timestamp,
            note: d.note
          }));

        const markerPoints = data
          .filter(d => d.type === 'marker')
          .map(d => ({
            lat: parseFloat(d.lat),
            lng: parseFloat(d.lng),
            note: d.note
          }));

        // 畫軌跡線
        const latlngs = trackPoints.map(p => [p.lat, p.lng]);
        if (latlngs.length) {
          const polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
          map.fitBounds(polyline.getBounds());

          // 歷史點
          trackPoints.slice(0, -1).forEach(p => {
            L.circleMarker([p.lat, p.lng], {
              radius: 6,
              color: 'gray',
              fillColor: '#555',
              fillOpacity: 0.6
            }).addTo(map).bindPopup(`<b>${p.note || '無備註'}</b><br>${p.timestamp}`);
          });

          // 最新點
          const latest = trackPoints[trackPoints.length - 1];
          L.marker([latest.lat, latest.lng], { icon: animalIcon })
            .addTo(map)
            .bindPopup(`<b>最新位置</b><br>${latest.timestamp}<br>${latest.note || ''}`);
        }

        // 額外標記點（不連線）
        markerPoints.forEach(p => {
          L.marker([p.lat, p.lng])
            .addTo(map)
            .bindPopup(`<b>${p.note || '標記點'}</b>`);
        });
      }
    });
  </script>
</body>
</html>
